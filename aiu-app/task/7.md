**Цель урока:** Научить вас создавать надежные React Native приложения с помощью комплексного тестирования, автоматизировать процессы сборки и развертывания с использованием GitLab CI/CD, а также эффективно отслеживать и устранять проблемы в production-среде.

**План урока:**

1.  **Глубокое погружение в тестирование React Native:**
    * **Юнит-тестирование (продвинутые техники):**
        * Мокирование зависимостей (API, нативные модули).
        * Тестирование хуков с использованием `react-hooks-testing-library`.
        * Тестирование сложных сценариев взаимодействия пользователя.
        * Написание тестируемого кода (SOLID принципы, чистые функции).
    * **Интеграционное тестирование (детали):**
        * Тестирование взаимодействия компонентов между собой.
        * Тестирование навигационных потоков.
        * Использование моков для внешних сервисов.
    * **E2E тестирование (практика с Detox):**
        * Настройка и запуск Detox.
        * Написание стабильных и атомарных E2E тестов.
        * Работа с элементами UI и выполнение действий пользователя.
        * Тестирование на реальных устройствах и эмуляторах.
    * **Визуальное регрессионное тестирование (введение):**
        * Использование библиотек для сравнения скриншотов UI.
        * Интеграция в пайплайн тестирования.
    * **Отчетность о покрытии кода тестами (Code Coverage).**
2.  **Непрерывная интеграция и непрерывное развертывание (CI/CD) с GitLab CI/CD:**
    * **Основные концепции CI/CD.**
    * **Знакомство с `.gitlab-ci.yml`.**
    * **Настройка пайплайна CI:**
        * Автоматическая сборка приложения (iOS и Android).
        * Запуск юнит-тестов и интеграционных тестов.
        * Анализ статического кода (ESLint, Prettier, Flow/TypeScript).
        * Создание артефактов сборки (IPA, APK).
    * **Настройка пайплайна CD:**
        * Автоматическое развертывание на тестовые среды (TestFlight, Google Play Console internal/alpha/beta).
        * Автоматическое развертывание в production (с стратегиями rollout).
        * Работа с секретами и переменными окружения в GitLab CI/CD.
        * Подписание кода для релизов.
3.  **Мониторинг и отслеживание ошибок в Production:**
    * **Инструменты мониторинга производительности (Sentry, New Relic, Datadog).**
        * Отслеживание ошибок и исключений в реальном времени.
        * Анализ производительности приложения (время загрузки, использование памяти, CPU).
        * Трассировка запросов и выявление узких мест.
    * **Инструменты отслеживания сбоев (Crashlytics - Firebase Crashlytics).**
        * Сбор подробных отчетов о сбоях.
        * Группировка сбоев и анализ причин.
        * Интеграция с системами отслеживания задач (Jira).
    * **Аналитика использования приложения (Firebase Analytics, Amplitude, Mixpanel).**
        * Отслеживание поведения пользователей и ключевых событий.
        * Сегментация аудитории и анализ воронок.
        * A/B тестирование фич и гипотез.
    * **Логирование в Production:**
        * Выбор стратегии логирования (централизованное логирование).
        * Уровни логирования и их использование.
        * Инструменты для просмотра и анализа логов.
    * **Алерты и уведомления о проблемах.**
4.  **Продвинутые стратегии развертывания:**
    * **Blue/Green Deployment.**
    * **Canary Releases.**
    * **Feature Flags (Toggle).**
    * **Rollback стратегии.**
5.  **Безопасность в CI/CD и Production:**
    * **Безопасное хранение и использование секретов (API ключи, токены).**
    * **Аудит пайплайнов CI/CD.**
    * **Защита от неавторизованного доступа к production-среде.**
    * **Регулярное обновление зависимостей и устранение уязвимостей.**

**Детальное рассмотрение некоторых пунктов:**

### 2. Непрерывная интеграция и непрерывное развертывание (CI/CD) с GitLab CI/CD

* **`.gitlab-ci.yml`:** Этот файл в корне вашего репозитория определяет пайплайн CI/CD. Он состоит из `stages` (этапов) и `jobs` (заданий). Задания выполняются в GitLab Runner.

* **Пример `.gitlab-ci.yml` для сборки Android и запуска тестов:**

    ```yaml
    image: node:18

    stages:
      - setup
      - test
      - build_android
      - deploy_beta_android

    cache:
      key: ${CI_COMMIT_REF_SLUG}-${CI_JOB_NAME}-node-modules
      paths:
        - node_modules/

    before_script:
      - npm install

    eslint:
      stage: setup
      script:
        - npx eslint .

    prettier:
      stage: setup
      script:
        - npx prettier --check .

    unit_tests:
      stage: test
      script:
        - npm test -- --coverage --watchAll=false
      coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
      artifacts:
        reports:
          junit: junit.xml
          coverage_report:
            coverage_format: lcov
            path: coverage/lcov.info

    build_android_job:
      stage: build_android
      image: reactnativecommunity/react-native-android
      variables:
        ANDROID_COMPILE_SDK_VERSION: "33"
        ANDROID_BUILD_TOOLS_VERSION: "33.0.0"
        GRADLE_OPTS: "-Dorg.gradle.daemon=false"
      before_script:
        - chmod +x ./android/gradlew
      script:
        - cd android
        - ./gradlew assembleRelease
      artifacts:
        paths:
          - android/app/build/outputs/apk/release/app-release.apk

    deploy_beta_android_job:
      stage: deploy_beta_android
      image: google/cloud-sdk
      before_script:
        - apt-get update -yq
        - apt-get install -yqq curl jq
        - echo "$PLAY_STORE_JSON_KEY" > /tmp/playstore.json
        - gcloud auth activate-service-account --key-file /tmp/playstore.json --project "$PLAY_STORE_PROJECT_ID"
      script:
        - curl -o google-play-publisher [https://github.com/Triple-T/gradle-play-publisher/releases/download/3.7.0/google-play-publisher-3.7.0.jar](https://github.com/Triple-T/gradle-play-publisher/releases/download/3.7.0/google-play-publisher-3.7.0.jar)
        - java -jar google-play-publisher --apk=android/app/build/outputs/apk/release/app-release.apk --track=beta --json=/tmp/playstore.json
      only:
        - main
      variables:
        PLAY_STORE_JSON_KEY: "$PLAY_STORE_JSON_KEY" # Определите как секретную переменную GitLab CI/CD
        PLAY_STORE_PROJECT_ID: "$PLAY_STORE_PROJECT_ID" # Определите как секретную переменную GitLab CI/CD
    ```

    * **`image`:** Определяет Docker-образ, в котором будет выполняться задание.
    * **`stages`:** Определяет последовательность этапов пайплайна.
    * **`cache`:** Кэширует `node_modules` для ускорения последующих запусков.
    * **`before_script`:** Скрипты, выполняемые перед основным скриптом задания.
    * **`script`:** Основные команды для выполнения задания.
    * **`artifacts`:** Файлы, которые будут сохранены после выполнения задания.
    * **`coverage`:** Настройки для сбора информации о покрытии кода тестами.
    * **`variables`:** Переменные окружения, доступные в задании. Секретные переменные GitLab CI/CD используются для хранения конфиденциальных данных.
    * **`only`:** Определяет, для каких веток запускать задание.

* **Настройка CI:** В этом примере настроены этапы для установки зависимостей, запуска линтеров и форматеров, выполнения юнит-тестов и сборки Android приложения.

* **Настройка CD:** Пример демонстрирует развертывание Android beta-версии в Google Play Store с использованием `gradle-play-publisher`. Вам потребуется настроить секретные переменные `PLAY_STORE_JSON_KEY` и `PLAY_STORE_PROJECT_ID` в настройках GitLab CI/CD вашего проекта. Аналогично можно настроить развертывание iOS приложений через TestFlight.

### 3. Мониторинг и отслеживание ошибок в Production

* **Sentry:** Интегрируйте SDK Sentry в ваше React Native приложение. В GitLab CI/CD можно настроить автоматическую отправку релизов в Sentry при каждом успешном деплое.
* **Firebase Crashlytics:** Добавьте Firebase SDK в ваше приложение. Отчеты о сбоях будут автоматически отправляться в Firebase console.
* **Аналитика (Firebase Analytics, Amplitude, Mixpanel):** Интегрируйте соответствующие SDK для отслеживания пользовательских событий.

### 4. Продвинутые стратегии развертывания

* GitLab CI/CD позволяет настраивать различные стратегии развертывания, используя различные окружения (environments) и контролируя процесс релиза. Например, можно использовать отдельные ветки для staging и production и настроить пайплайны для автоматического развертывания на эти окружения.
* **Feature Flags:** Интегрируйте библиотеку feature flags и используйте GitLab CI/CD для управления их включением/выключением в разных окружениях.

### 5. Безопасность в CI/CD и Production

* **Секретные переменные GitLab CI/CD:** Используйте секретные переменные для хранения конфиденциальных данных (ключей API, токенов, учетных данных) и избегайте их хранения в коде.
* **Аудит пайплайнов:** Регулярно проверяйте конфигурацию вашего `.gitlab-ci.yml` на предмет потенциальных уязвимостей.
* **Ограничение доступа:** Ограничьте доступ к production-среде только авторизованным пользователям и процессам.

**Практические задания:**

1.  **Настройка базового GitLab CI/CD пайплайна:** Создайте `.gitlab-ci.yml`, который выполняет линтинг (ESLint, Prettier) и запускает юнит-тесты для вашего React Native проекта.
2.  **Сборка Android APK в GitLab CI/CD:** Добавьте задание в ваш `.gitlab-ci.yml` для сборки release APK вашего Android приложения.
3.  **Интеграция Sentry с GitLab CI/CD:** Настройте отправку релизов в Sentry из вашего пайплайна GitLab CI/CD при успешном развертывании.
4.  **Использование секретных переменных:** Определите и используйте секретную переменную в вашем `.gitlab-ci.yml`.

**Заключение:**

Использование GitLab CI/CD в сочетании с комплексным тестированием и мониторингом production является неотъемлемой частью современной разработки React Native приложений. Автоматизация процессов сборки, тестирования и развертывания позволяет повысить качество приложения, сократить время выхода новых версий и оперативно реагировать на проблемы в production. Инвестируйте время в изучение и настройку этих инструментов, чтобы сделать ваш процесс разработки более эффективным и надежным.
